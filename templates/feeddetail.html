{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>feed</title>
    <link href="{% static 'css/feeddetail.css' %}" rel="stylesheet">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <script defer src="{% static 'js/index.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
{% block static %}{% endblock static %}
</head>
<body>
{% block content %}
<!--헤더 + 네비게이션 바-->
{#    <header>#}
{#        <div class="header">#}
{#            <img class="logo" src="{% static 'img/textlogo_white.png' %}">#}
{#            <nav>#}
{#                <ul class="nav-link">#}
{#                    <li><a href="{% url '' %}">store</a></li>#}
{#                    <li><a href="{% url '' %}">order</a></li>#}
{#                    <li><a href="{% url '' %}">mypage</a></li>#}
{#                </ul>#}
{#                <div class="m-nav-link">#}
{#                    <a id="list" href="{% url '' %}"><img src="{% static 'img/list_white.png' %}"></a>#}
{#                    <a href="{% url '' %}"><img src="{% static 'img/order_white.png' %}"></a>#}
{#                    <a href="{% url '' %}"><img src="{% static 'img/profile_white.png' %}"></a>#}
{#                </div>#}
{#                <div class="m-nav-menu">#}
{#                    <li><a href="{% url '' %}">store</a></li>#}
{#                    <li><a href="{% url '' %}">order</a></li>#}
{#                    <li><a href="{% url '' %}">mypage</a></li>#}
{#                </div>#}
{#            </nav>#}
{#            <a class="sign" href="{% url '' %}"><button>log in</button></a>#}
{#        </div>#}
{#    </header>#}
<!-- feed -->
    <div class="feed">
        {% if feed.user_id == user %}
            <a href="{% url "feed:update_feed" feed_id=feed.id %}">
                <button>수정</button>
            </a>
            <a href="{% url "feed:delete_feed" feed_id=feed.id %}">
                <button>삭제</button>
            </a>
        {% endif %}
        <img src="{{ feed.image }}">
        <!-- 게시물 관련 변수 확인 변경 필요 -->
        <button id="feed-title">{{ feed.title }}</button>
        <h5 id="date">{{ feed.created_at|date:"y-m-d" }}</h5>
        <h5 id="username">{{ feed.user_id.nickname }}</h5>
        <div id="contents">
            <h5>조회수 : {{ feed.views }}</h5>
            <h5>{{ feed.like_count }}명이 좋아합니다</h5>
            <h5>내용 : {{ feed.content }}</h5>
        </div>
        <div class="comment">
            <h5>댓글</h5>
            <!-- 코멘트 반복문 시작 -->
            <!-- for comment in feed.feed_comment.all 사용 가능-->
            {% for comment in comments %}
                <div id="comment_{{ comment.id }}_div">
                    <h5>{{ comment.user_id.nickname }}</h5>
                    <h5> - {{ comment.created_at }}</h5>
                    <input id="comment_{{ comment.id }}_input" type="text" value="{{ comment.content }} "
                           readonly required size="100" maxlength="100">
                    {% if comment.user_id == user %}
                        <a href="#comment_{{ comment.id }}_input" id="comment_update_{{ comment.id }}"
                           onclick="update_comment({{ comment.id }})">
                            <button>수정</button>
                        </a>
                        <a href="#comment_{{ comment.id }}_input" id="comment_update_api_{{ comment.id }}"
                           onclick="update_comment_api({{ comment.id }})" style="display: none">
                            <button>전송</button>
                        </a>
                        <a href="{% url "feed:delete_comment" feed_id=feed.id comment_id=comment.id %}">
                            <button>삭제</button>
                        </a>
                    {% endif %}
                </div>
            {% endfor %}
            <!-- 코멘트 반복문 끝 -->
            <h5>댓글 작성하기</h5>
            <!-- 코멘트 input -->
            <form action="{% url "feed:create_comment" feed_id=feed.id %}" method="POST">
                {% csrf_token %}
                <input type="text" name="comment_content" id="comment_content" required size="100" maxlength="100" >
                <button type="submit">작성하기</button>
            </form>
            <!-- 코멘트 input 끝 -->
        </div>
    </div>

<!--footer-->
    <footer>
        <div class="footer">
            <h4>Website created with Team 4-tune</h4>
        </div>
        <ul class="m-footer-link">
            <li><a href=""><i class="fi fi-rr-heart"></i></a></li>
            <li><a href=""><i class="fi fi-rr-bookmark"></i></a></li>
            <li><a href=""><i class="fi fi-rr-share"></i></a></li>
        </ul>
    </footer>
    <script type="text/javascript">
        //댓글 수정 가능 함수
        function update_comment(id) {
            const commentInput = document.querySelector(`#comment_${id}_input`);
            const submitButton = document.querySelector(`#comment_update_api_${id}`);
            const updateButton = document.querySelector(`#comment_update_${id}`);

            updateButton.style.display = "none"; // 수정 버튼 숨기기
            submitButton.style.display = "inline-block"; // 전송 버튼 표시
            commentInput.readOnly = false; // 댓글 input 태그 수정 가능하게 변경
        }

                // 수정 댓글 전송 함수
        function update_comment_api(id) {
            const commentInput = document.querySelector(`#comment_${id}_input`);
            const submitButton = document.querySelector(`#comment_update_api_${id}`);
            const updateButton = document.querySelector(`#comment_update_${id}`);
            const content = commentInput.value;
            // ajax 비동기 통신
            $.ajax({
                type: "POST", // request 전달 방식 (POST, GET 등)
                url: "{% url "feed:update_comment" %}", // api 요청 url
                headers: {//헤더에 csrf 토큰 추가
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {// json 형식으로 서버에 데이터 전달
                    'comment_id': id,
                    'content': content,
                },
                dataType: "json", // json 형식으로 데이터 주고 받기
                success: function (response) { // 통신 성공했을 때 호출 함수
                    //console.log(response.msg)
                    updateButton.style.display = "inline-block"; // 수정 버튼 표시
                    submitButton.style.display = "none"; // 전송 버튼 숨기기
                    commentInput.readOnly = true; // 댓글 수정 못하게 막기
                },
                error: function () { // 통신 실패했을 때 호출 함수
                    alert("댓글 수정 실패");
                },
            });
        }

        // 좋아요 함수
        function like_api(id) {
            // ajax 비동기 통신
            $.ajax({
                type: "POST", // request 전달 방식 (POST, GET 등)
                url: "{% url "feed:api_like" %}", // api 요청 url
                headers: {//헤더에 csrf 토큰 추가
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {// json 형식으로 서버에 데이터 전달
                    'feed_id': id,
                },
                dataType: "json", // json 형식으로 데이터 주고 받기
                success: function (response) { // 통신 성공했을 때 호출 함수
                    console.log(response.msg)
                    console.log(response.like_count)
                    if (response.msg === "좋아요") {
                        // like 버튼의 클래스를 변경(채워져 있는 하트) / jquery 문법
                        $('#like_btn_' + id).attr("class", "filled_heart")
                    } else if (response.msg === "좋아요 취소") {
                        // like 버튼의 클래스를 변경(비어있는 하트) / jquery 문법
                        $('#like_btn_' + id).attr("class", "default_heart")
                    }
                    // 좋아요 숫자를 서버에서 전달받은 숫자로 변경 / jquert 문법
                    $("#like_count").text(`${response.like_count}명이 좋아합니다`);
                },
                error: function () { // 통신 실패했을 때 호출 함수
                    alert("좋아요 실패\n로그인을 해주세요 :)");
                },
            });
        }

        // 북마크 함수
        function bookmark_api(id) {
            // ajax 비동기 통신
            $.ajax({
                type: "POST", // request 전달 방식 (POST, GET 등)
                url: "{% url "feed:api_bookmark" %}", // api 요청 url
                headers: {//헤더에 csrf 토큰 추가
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {// json 형식으로 서버에 데이터 전달
                    'feed_id': id,
                },
                dataType: "json", // json 형식으로 데이터 주고 받기
                success: function (response) { // 통신 성공했을 때 호출 함수
                    console.log(response.msg)
                    if (response.msg === "북마크") {
                        // 북마크 버튼의 클래스를 변경 / jquery 문법
                        $('#bookmark_btn_' + id).attr("class", "filled_bookmark")
                    } else if (response.msg === "북마크 취소") {
                        // 북마크 버튼의 클래스를 변경 / jquery 문법
                        $('#bookmark_btn_' + id).attr("class", "default_bookmark")
                    }
                },
                error: function () { // 통신 실패했을 때 호출 함수
                    alert("북마크 실패\n로그인을 해주세요 :)");
                },
            });
        }
    </script>
{% endblock content %}
</body>
</html>