<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <script type="text/javascript">
        //댓글 수정 가능 함수
        function update_comment(id) {
            const commentInput = document.querySelector(`#comment_${id}_input`);
            const submitButton = document.querySelector(`#comment_update_api_${id}`);
            const updateButton = document.querySelector(`#comment_update_${id}`);

            updateButton.style.display = "none"; // 수정 버튼 숨기기
            submitButton.style.display = "inline-block"; // 전송 버튼 표시
            commentInput.readOnly = false; // 댓글 input 태그 수정 가능하게 변경
        }

        // 수정 댓글 전송 함수
        function update_comment_api(id) {
            const commentInput = document.querySelector(`#comment_${id}_input`);
            const submitButton = document.querySelector(`#comment_update_api_${id}`);
            const updateButton = document.querySelector(`#comment_update_${id}`);
            const content = commentInput.value;
            // ajax 비동기 통신
            $.ajax({
                type: "POST", // request 전달 방식 (POST, GET 등)
                url: "{% url "feed:update_comment" %}", // api 요청 url
                headers: {//헤더에 csrf 토큰 추가
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                data: {// json 형식으로 서버에 데이터 전달
                    'comment_id': id,
                    'content': content,
                },
                dataType: "json", // json 형식으로 데이터 주고 받기
                success: function (response) { // 통신 성공했을 때 호출 함수
                    //console.log(response.msg)
                    updateButton.style.display = "inline-block"; // 수정 버튼 표시
                    submitButton.style.display = "none"; // 전송 버튼 숨기기
                    commentInput.readOnly = true; // 댓글 수정 못하게 막기
                },
                error: function () { // 통신 실패했을 때 호출 함수
                    alert("댓글 수정 실패");
                },
            });
        }
    </script>
</head>
<body>
<div>
    <a href="{% url "feed:community" %}">커뮤니티 페이지로 이동</a> <br>
    {% if feed.user_id == user %}
        <a href="{% url "feed:delete_feed" feed_id=feed.id %}">
            <span>수정</span>
        </a>
    {% endif %}
    {% if feed.user_id == user %}
        <a href="{% url "feed:delete_feed" feed_id=feed.id %}">
            <span>삭제</span>
        </a>
    {% endif %}
    <br>
    <div id="feed_{{ feed.id }}">
        <p>제목 : {{ feed.title }}</p>
        <img src="{{ feed.image }}"
             alt="{{ feed.user_id.nickname }}">
        <p>내용 : {{ feed.content }}</p>
        <p>작성 시간 : {{ feed.created_at|date:"y-m-d" }}</p>
        <p>작성자 닉네임 : {{ feed.user_id.nickname }}</p>
        <p>좋아요 수 : {{ feed.like_count }}</p>
        <!-- 좋아요, 북마크 조건문 시작 -->
        {# 내가 좋아요한 피드면 #}
        {% if feed.my_likes %}
            {# 하트에 빨간표시! #}
            <a href="{% url "feed:undo_like" feed.id %}">
                <span>좋아요 취소</span>
            </a>
            {# 내가 좋아요한 피드가 아니면 #}
        {% else %}
            {# 그냥 하트 #}
            <a href="{% url "feed:do_like" feed.id %}">
                <span>좋아요</span>
            </a>
        {% endif %}
        <br>
        {# 내가 북마크한 피드면 #}
        {% if feed.my_bookmark %}
            {# 체크된 북마크 #}
            <a href="{% url "feed:undo_bookmark" feed.id %}">
                <span>북마크 취소</span>
            </a>
            {# 내가 북마크한 피드가 아니면 #}
        {% else %}
            {# 그냥 북마크 #}
            <a href="{% url "feed:do_bookmark" feed.id %}">
                <span>북마크</span>
            </a>
        {% endif %}
        <!-- 좋아요, 북마크 조건문 끝 -->
    </div>
    <br>
    <br>
    <!-- 코멘트 반복문 시작 -->
    <!-- for comment in feed.feed_comment.all 사용 가능-->
    {% for comment in comments %}
        <div id="comment_{{ comment.id }}_div">
            <span>{{ comment.user_id.nickname }}</span>
            <span> - {{ comment.created_at }}</span><br>
            {% if comment.created_at != comment.updated_at %}
                <span>(수정됨)</span>
            {% endif %}
            <input id="comment_{{ comment.id }}_input" type="text" value="{{ comment.content }}"
                   readonly size="100" maxlength="100">
            {% if comment.user_id == user %}
                <a href="#comment_{{ comment.id }}_input" id="comment_update_{{ comment.id }}"
                   onclick="update_comment({{ comment.id }})">
                    <button>수정</button>
                </a>
                <a href="#comment_{{ comment.id }}_input" id="comment_update_api_{{ comment.id }}"
                   onclick="update_comment_api({{ comment.id }})" style="display: none">
                    <button>전송</button>
                </a>
                <a href="{% url "feed:delete_comment" feed_id=feed.id comment_id=comment.id %}">
                    <button>삭제</button>
                </a>
            {% endif %}
        </div>
    {% endfor %}
    <!-- 코멘트 반복문 끝 -->
</div>
<br><br>
<form action="{% url "feed:create_comment" feed_id=feed.id %}" method="POST">
    {% csrf_token %}
    <input type="text" name="comment_content" id="comment_content" required size="100" maxlength="100">
    <button type="submit">작성하기</button>
</form>
</body>
</html>